# PRP: Auto-Detect Agents Feature

**Date:** 2025-12-15
**Feature:** Add auto-detect function to enable only installed CLI agents
**Confidence Score:** 8/10

## Overview

Add an "Auto-detect agents" action under the "Check all CLI versions" menu item. This feature will:
1. First enable all built-in agents
2. Run `command -v <command>` (Unix) or `where <command>` (Windows) for each agent
3. Disable agents that are not installed
4. Show a notification with results

## Requirements

1. Add a new menu item "Auto-detect installed agents" in the dropdown
2. When clicked:
   - Enable all 14 built-in agents
   - Check each agent's command availability using synchronous process execution
   - Disable agents whose commands are not found
   - Show a notification summarizing results (e.g., "Found 5 of 14 agents")
3. Cross-platform support: Windows (PowerShell/cmd) and Unix (bash)

## Affected Files

| File | Changes |
|------|---------|
| `AgentDetector.kt` (new) | New utility class for detecting installed agents |
| `LlmBrainsActionGroup.kt` | Add "Auto-detect installed agents" action |
| `AgentSettingsState.kt` | Add method to enable all agents |

## Implementation Details

### 1. AgentDetector.kt (new file)

Create a new utility class to detect if CLI commands are available:

```kotlin
package com.forret.llmbrains

import java.io.IOException
import java.util.concurrent.TimeUnit

object AgentDetector {
    private const val TIMEOUT_MS = 5000L

    /**
     * Check if a command is available on the system.
     * Uses "command -v" on Unix or "where" on Windows.
     */
    fun isCommandAvailable(command: String): Boolean {
        return try {
            val process = if (OsDetector.isWindows()) {
                ProcessBuilder("where", command)
                    .redirectErrorStream(true)
                    .start()
            } else {
                // Use bash login shell to get full PATH
                ProcessBuilder("bash", "-lc", "command -v $command")
                    .redirectErrorStream(true)
                    .start()
            }

            val completed = process.waitFor(TIMEOUT_MS, TimeUnit.MILLISECONDS)
            if (!completed) {
                process.destroyForcibly()
                return false
            }

            process.exitValue() == 0
        } catch (e: IOException) {
            false
        } catch (e: InterruptedException) {
            Thread.currentThread().interrupt()
            false
        }
    }

    /**
     * Detect all installed agents and return a map of agent ID to installed status.
     */
    fun detectAllAgents(): Map<String, Boolean> {
        return CodingAgents.all.associate { agent ->
            agent.id to isCommandAvailable(agent.command)
        }
    }

    /**
     * Auto-detect and configure agents.
     * Returns pair of (enabled count, total count).
     */
    fun autoDetectAndConfigure(): Pair<Int, Int> {
        val settings = AgentSettingsState.getInstance()

        // First, enable all agents
        settings.enableAllAgents()

        // Detect which commands are available
        val results = detectAllAgents()

        // Disable agents that are not installed
        var enabledCount = 0
        results.forEach { (id, isInstalled) ->
            settings.setAgentActive(id, isInstalled)
            if (isInstalled) enabledCount++
        }

        return Pair(enabledCount, results.size)
    }
}
```

### 2. AgentSettingsState.kt

Add method to enable all built-in agents:

```kotlin
fun enableAllAgents() {
    state.inactiveAgentIds.clear()
}
```

### 3. LlmBrainsActionGroup.kt

Add the auto-detect action after "Check all CLI versions":

```kotlin
actions += SimpleRunAction("üîç Auto-detect installed agents") {
    val (enabled, total) = AgentDetector.autoDetectAndConfigure()
    // Show notification using IntelliJ notification system
    val message = "Found $enabled of $total CLI agents installed"
    com.intellij.notification.NotificationGroupManager.getInstance()
        .getNotificationGroup("LLM Brains")
        .createNotification(message, com.intellij.notification.NotificationType.INFORMATION)
        .notify(project)
}
```

Also need to register the notification group in plugin.xml:

```xml
<extensions defaultExtensionNs="com.intellij">
    <notificationGroup id="LLM Brains" displayType="BALLOON"/>
    <!-- existing applicationConfigurable -->
</extensions>
```

## Code Patterns Reference

### Existing OS Detection Pattern (OsDetector.kt)
```kotlin
object OsDetector {
    fun isWindows(): Boolean = System.getProperty("os.name")
        .lowercase()
        .contains("windows")
}
```

### Existing Settings Update Pattern (AgentSettingsState.kt:30-36)
```kotlin
fun setAgentActive(id: String, active: Boolean) {
    if (active) {
        state.inactiveAgentIds.remove(id)
    } else if (id !in state.inactiveAgentIds) {
        state.inactiveAgentIds.add(id)
    }
}
```

### Existing Action Pattern (LlmBrainsActionGroup.kt:43-48)
```kotlin
actions += SimpleRunAction("ü§î Check all CLI versions") {
    project?.let { TerminalCommandRunner.run(it, "ü§î Check Agents", buildCheckScript()) }
}
```

### Shell Script Detection Pattern (llmbrains.sh:58)
```bash
if command -v "$binary" >/dev/null 2>&1; then
```

## Required Imports

For `AgentDetector.kt`:
```kotlin
import java.io.IOException
import java.util.concurrent.TimeUnit
```

For `LlmBrainsActionGroup.kt` (add these):
```kotlin
import com.intellij.notification.NotificationGroupManager
import com.intellij.notification.NotificationType
```

## Implementation Tasks (in order)

1. **plugin.xml**: Add notification group registration
2. **AgentSettingsState.kt**: Add `enableAllAgents()` method
3. **AgentDetector.kt**: Create new file with detection logic
4. **LlmBrainsActionGroup.kt**: Add import for notification classes
5. **LlmBrainsActionGroup.kt**: Add auto-detect action after "Check all CLI versions"
6. **Build**: Run `./gradlew build` to verify compilation
7. **Test manually**: Run `./gradlew runIde` and verify functionality

## Validation Gates

```bash
# Build verification
./gradlew build

# Code formatting
./gradlew ktlintFormat

# Run sandbox IDE for manual testing
./gradlew runIde
```

### Manual Test Cases

1. **Auto-detect with some agents installed**
   - Click toolbar button > "Auto-detect installed agents"
   - Verify balloon notification shows count (e.g., "Found 3 of 14 CLI agents installed")
   - Open Settings > LLM Brains
   - Verify only installed agents are checked

2. **Auto-detect with no agents installed**
   - Ensure no CLI agents are in PATH
   - Click "Auto-detect installed agents"
   - Verify notification shows "Found 0 of 14 CLI agents installed"
   - Verify all agents are unchecked in settings

3. **Auto-detect enables previously disabled agents**
   - Disable all agents in settings
   - Install one agent (e.g., `npm install -g @anthropic-ai/claude-code`)
   - Click "Auto-detect installed agents"
   - Verify installed agent is now enabled

4. **Cross-platform: Windows**
   - Test on Windows with some agents installed via npm
   - Verify detection works using `where` command

5. **Cross-platform: Unix/macOS**
   - Test on macOS/Linux
   - Verify detection uses `bash -lc "command -v"` to get login shell PATH

6. **Timeout handling**
   - If a command hangs (unlikely), verify detection completes within 5 seconds
   - That agent should be marked as not installed

## Documentation Reference

- IntelliJ Platform SDK - Notifications: https://plugins.jetbrains.com/docs/intellij/notifications.html
- Java ProcessBuilder: https://docs.oracle.com/en/java/javase/17/docs/api/java.base/java/lang/ProcessBuilder.html
- Bash command -v: https://www.gnu.org/software/bash/manual/html_node/Bash-Builtins.html

## Edge Cases & Error Handling

1. **Command timeout**: Use 5-second timeout per command, mark as not installed if timeout
2. **IOException**: Catch and treat as not installed
3. **InterruptedException**: Re-interrupt thread, treat as not installed
4. **Empty PATH**: Using `bash -lc` ensures login shell PATH is loaded
5. **Windows PATH issues**: `where` command should find npm-installed tools
6. **Concurrent modification**: Settings updates are synchronous, no threading issues

## Platform-Specific Considerations

### Unix/macOS
- Use `bash -lc "command -v <cmd>"` to ensure PATH includes npm global bin
- The `-l` flag loads login shell profile (~/.bash_profile, ~/.bashrc)
- This matches how the existing check scripts work

### Windows
- Use `where <cmd>` which is the Windows equivalent of `command -v`
- npm global installs go to `%APPDATA%\npm` which is typically in PATH
- Alternative: Could use PowerShell `Get-Command` but `where` is simpler

## Alternative Approaches Considered

1. **Extend shell scripts**: Add `detect-all` subcommand to llmbrains.sh
   - Rejected: Would require terminal output parsing, complex

2. **Run detection in background thread**
   - Rejected: Adds complexity, synchronous is fast enough (14 agents x 5s max = 70s worst case, typically <1s)

3. **Cache detection results**
   - Not implemented: Detection is quick, caching adds staleness issues

## Quality Checklist

- [x] All necessary context included
- [x] Validation gates are executable
- [x] References existing patterns
- [x] Clear implementation path
- [x] Error handling documented
- [x] Required imports identified
- [x] Manual test cases defined
- [x] Cross-platform considerations documented

## Confidence Score: 8/10

High confidence because:
- Uses standard Java ProcessBuilder for process execution
- Simple extension of existing patterns
- Clear cross-platform strategy (command -v vs where)
- No new dependencies required
- Existing OsDetector pattern to follow

Minor uncertainties:
- Windows `where` behavior with npm-installed commands (should work, but needs testing)
- Login shell PATH loading on different Unix configurations
- Notification group registration syntax for different IntelliJ versions

## Pseudocode Flow

```
User clicks "Auto-detect installed agents"
    |
    v
enableAllAgents()  // Clear inactiveAgentIds list
    |
    v
For each agent in CodingAgents.all:
    |
    +--[Windows?]---> Run: where <command>
    |                     |
    +--[Unix?]------> Run: bash -lc "command -v <command>"
    |
    v
Check exit code (0 = found, non-zero = not found)
    |
    v
setAgentActive(agent.id, isFound)
    |
    v
Count installed agents
    |
    v
Show notification: "Found X of 14 CLI agents installed"
```
